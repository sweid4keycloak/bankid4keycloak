# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- none

resources:
- repo: self
variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'alf-azure-container-svc-con'
  imageRepository: 'auth/alf-bankid6-keycloak'
  containerRegistry: 'alfprivatecontainerregistry.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile' 
  vmImageName: 'ubuntu-latest'
 
 
   
stages:
- stage: Build
  displayName: Build and push stage
  jobs:  
  - job: Build
    displayName: Build
    pool: Default
     # vmImage: $(vmImageName)
    steps:
      - checkout: self
      - script: |
          echo Starting the build
          echo $PATH
          export MAVEN_HOME=/opt/maven
          export PATH=$MAVEN_HOME/bin:$PATH 
          git tag -l
          TAG=$(git tag -l --sort=-v:refname | head -n 1)
          java -version
          mvn -version
          mvn package
        displayName: 'Build with Maven'
      
      - task: Docker@2
        displayName: Build and push an image to container registry
        inputs:
          command: buildAndPush
          repository: $(imageRepository)
          dockerfile: $(dockerfilePath)
          containerRegistry: $(dockerRegistryServiceConnection)
          tags: |
            $(TAG)